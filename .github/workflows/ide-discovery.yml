name: Weekly AI IDE Discovery

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  discover:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Run IDE discovery script
        run: |
          cd ai-ide-comparison
          node auto-discover.js
        continue-on-error: true
      
      - name: Check if discoveries were made
        id: check_discoveries
        run: |
          cd ai-ide-comparison
          if ls discoveries-*.json 1> /dev/null 2>&1; then
            echo "has_discoveries=true" >> $GITHUB_OUTPUT
            count=$(cat discoveries-*.json | jq 'length')
            echo "discovery_count=$count" >> $GITHUB_OUTPUT
          else
            echo "has_discoveries=false" >> $GITHUB_OUTPUT
            echo "No new AI IDEs discovered this week"
          fi
      
      - name: Create Pull Request if discoveries found
        if: steps.check_discoveries.outputs.has_discoveries == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat: Weekly AI IDE discovery results'
          title: 'üîç ${{ steps.check_discoveries.outputs.discovery_count }} New AI IDEs Discovered'
          body: |
            ## Automated AI IDE Discovery
            
            This PR contains the results of the weekly AI IDE discovery scan.
            
            **Discoveries:** ${{ steps.check_discoveries.outputs.discovery_count }} new AI IDEs found
            
            **Review the discoveries:**
            - Check `ai-ide-comparison/discoveries-*.md` for the full report
            - Manually test promising IDEs
            - Update the comparison page if warranted
            
            **Next Steps:**
            1. Review each discovery
            2. Test viable candidates (2-4 hours each)
            3. Assign tier (S/A/B)
            4. Update `ai-ide-comparison/index.html`
            5. Merge this PR
          branch: ide-discovery-automated
          delete-branch: true
      
      - name: Create summary comment
        if: steps.check_discoveries.outputs.has_discoveries == 'false'
        run: |
          echo "‚úÖ Discovery scan completed successfully"
          echo "üìä Result: No new AI IDEs found"
          echo "üîç All major AI IDEs are already tracked in the comparison"
          echo "‚è∞ Next scan: Next Monday at 9 AM UTC"
      
      - name: Comment on issue if discoveries found
        if: steps.check_discoveries.outputs.has_discoveries == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const discoveries = fs.readdirSync('ai-ide-comparison')
              .filter(f => f.startsWith('discoveries-') && f.endsWith('.json'));
            
            if (discoveries.length > 0) {
              const data = JSON.parse(fs.readFileSync(`ai-ide-comparison/${discoveries[0]}`, 'utf8'));
              
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üîç ${data.length} New AI IDEs Discovered`,
                body: `Automated discovery found ${data.length} potential new AI IDEs.\n\nCheck the PR for details and manual review.`,
                labels: ['ai-ides', 'automated-discovery', 'needs-review']
              });
            }

