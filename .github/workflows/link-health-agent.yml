name: LHA - Link Health Agent

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    paths:
      - '**.html'
      - '**.md'
      - 'index.html'

jobs:
  check-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install linkinator
        run: npm install -g linkinator

      - name: Scan for broken links
        id: scan
        continue-on-error: true
        run: |
          echo "ðŸ” Scanning for broken links..."
          
          # Scan HTML and Markdown files
          linkinator . \
            --recurse \
            --skip "https://github.com" \
            --skip "https://linkedin.com" \
            --skip "https://twitter.com" \
            --skip "mailto:" \
            --format json \
            --markdown \
            --html \
            > link-scan-results.json 2>&1 || true
          
          # Parse results
          if [ -f link-scan-results.json ]; then
            BROKEN_COUNT=$(cat link-scan-results.json | jq '[.[] | select(.status >= 400)] | length' 2>/dev/null || echo "0")
            TOTAL_COUNT=$(cat link-scan-results.json | jq 'length' 2>/dev/null || echo "0")
            
            echo "broken_count=$BROKEN_COUNT" >> $GITHUB_OUTPUT
            echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
            
            # Extract broken links
            cat link-scan-results.json | jq '[.[] | select(.status >= 400)] | .[] | "\(.url) - \(.status) - \(.parent)"' > broken-links.txt 2>/dev/null || echo "" > broken-links.txt
          else
            echo "broken_count=0" >> $GITHUB_OUTPUT
            echo "total_count=0" >> $GITHUB_OUTPUT
            echo "" > broken-links.txt
          fi

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Analyze broken links
        id: analyze
        run: |
          if [ -f broken-links.txt ] && [ -s broken-links.txt ]; then
            BROKEN_LINKS=$(cat broken-links.txt)
            echo "broken_links<<EOF" >> $GITHUB_OUTPUT
            echo "$BROKEN_LINKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Categorize broken links
            INTERNAL=$(echo "$BROKEN_LINKS" | grep -c "elamcb.github.io\|github.com/ElaMCB" || echo "0")
            EXTERNAL=$(echo "$BROKEN_LINKS" | grep -v "elamcb.github.io\|github.com/ElaMCB" | wc -l || echo "0")
            
            echo "internal_broken=$INTERNAL" >> $GITHUB_OUTPUT
            echo "external_broken=$EXTERNAL" >> $GITHUB_OUTPUT
            echo "has_broken=true" >> $GITHUB_OUTPUT
          else
            echo "has_broken=false" >> $GITHUB_OUTPUT
            echo "internal_broken=0" >> $GITHUB_OUTPUT
            echo "external_broken=0" >> $GITHUB_OUTPUT
          fi

      - name: Create fix PR for broken links
        if: steps.analyze.outputs.has_broken == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”§ Creating fix for broken links..."
          
          # Create branch
          BRANCH_NAME="lha/fix-broken-links-$(date +%Y%m%d)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          
          # Create fix report
          cat > docs/link-health-report.md <<EOF
          # Link Health Report - $(date +%Y-%m-%d)
          
          ## Summary
          - **Total Links Scanned**: ${{ steps.scan.outputs.total_count }}
          - **Broken Links Found**: ${{ steps.scan.outputs.broken_count }}
          - **Internal Broken**: ${{ steps.analyze.outputs.internal_broken }}
          - **External Broken**: ${{ steps.analyze.outputs.external_broken }}
          
          ## Broken Links
          
          \`\`\`
          ${{ steps.analyze.outputs.broken_links }}
          \`\`\`
          
          ## Next Steps
          
          This report was generated by LHA (Link Health Agent). Please review and fix the broken links listed above.
          
          ---
          *Generated by LHA - Link Health Agent*
          EOF
          
          git add docs/link-health-report.md
          git commit -m "ðŸ”— LHA: Link health report - ${{ steps.scan.outputs.broken_count }} broken links found" || exit 0
          
          # Create PR
          gh pr create \
            --title "ðŸ”— LHA: Fix broken links (${{ steps.scan.outputs.broken_count }} found)" \
            --body "## Link Health Report
          
          **Broken Links**: ${{ steps.scan.outputs.broken_count }} / ${{ steps.scan.outputs.total_count }}
          - Internal: ${{ steps.analyze.outputs.internal_broken }}
          - External: ${{ steps.analyze.outputs.external_broken }}
          
          ## Broken Links Detected
          
          \`\`\`
          ${{ steps.analyze.outputs.broken_links }}
          \`\`\`
          
          ## Action Required
          
          Please review the broken links and fix them. The report has been saved to \`docs/link-health-report.md\`.
          
          ---
          *Generated by LHA (Link Health Agent)*" \
            --label "link-health,automated" || echo "PR creation skipped (may already exist)"

      - name: Create issue for critical broken links
        if: steps.analyze.outputs.has_broken == 'true' && steps.analyze.outputs.internal_broken > '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸ”— LHA: Critical - ${{ steps.analyze.outputs.internal_broken }} internal broken links detected" \
            --body "## Critical Link Health Issue
          
          **Internal Broken Links**: ${{ steps.analyze.outputs.internal_broken }}
          **External Broken Links**: ${{ steps.analyze.outputs.external_broken }}
          **Total Broken**: ${{ steps.scan.outputs.broken_count }}
          
          ## Broken Links
          
          \`\`\`
          ${{ steps.analyze.outputs.broken_links }}
          \`\`\`
          
          ## Priority
          
          Internal broken links should be fixed immediately as they affect user experience on the portfolio site.
          
          ---
          *Generated by LHA (Link Health Agent)*" \
            --label "link-health,critical,automated" || echo "Issue may already exist"

      - name: Success summary
        if: steps.analyze.outputs.has_broken == 'false'
        run: |
          echo "âœ… All links are healthy!"
          echo "Total links scanned: ${{ steps.scan.outputs.total_count }}"
          echo "Broken links: 0"

