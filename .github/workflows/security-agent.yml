name: SA - Security Agent (DEPRECATED - Use UAA)

# âš ï¸ DEPRECATED: This workflow is replaced by Unified Autonomous Agent (UAA)
# The UAA workflow provides the same Security capability with better architecture
# This workflow is disabled but kept for reference

on:
  workflow_dispatch:  # Only allow manual runs for migration period
  # schedule:  # DISABLED - Use UAA instead
  # push:  # DISABLED - Use UAA instead
  schedule:
    # Run every Monday at 10 AM UTC
    - cron: '0 10 * * 1'
  workflow_dispatch:
  push:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '**/*.js'
      - '**/*.py'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        id: npm-audit
        continue-on-error: true
        run: |
          echo "ðŸ”’ Running npm security audit..."
          
          npm audit --json > npm-audit-results.json 2>&1 || true
          
          if [ -f npm-audit-results.json ]; then
            VULNERABILITIES=$(cat npm-audit-results.json | jq '.vulnerabilities | length' 2>/dev/null || echo "0")
            CRITICAL=$(cat npm-audit-results.json | jq '[.vulnerabilities[] | select(.severity == "critical")] | length' 2>/dev/null || echo "0")
            HIGH=$(cat npm-audit-results.json | jq '[.vulnerabilities[] | select(.severity == "high")] | length' 2>/dev/null || echo "0")
            MODERATE=$(cat npm-audit-results.json | jq '[.vulnerabilities[] | select(.severity == "moderate")] | length' 2>/dev/null || echo "0")
            
            echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
            
            # Extract vulnerability details
            cat npm-audit-results.json | jq -r '.vulnerabilities | to_entries[] | "\(.key): \(.value.severity) - \(.value.title)"' > vulnerabilities.txt 2>/dev/null || echo "" > vulnerabilities.txt
          else
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "moderate=0" >> $GITHUB_OUTPUT
            echo "" > vulnerabilities.txt
          fi

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for exposed secrets
        id: secret-scan
        continue-on-error: true
        run: |
          echo "ðŸ” Scanning for exposed secrets..."
          
          # Common secret patterns
          SECRET_PATTERNS=(
            "AKIA[0-9A-Z]{16}"  # AWS Access Key
            "sk_live_[0-9a-zA-Z]{32}"  # Stripe
            "ghp_[0-9a-zA-Z]{36}"  # GitHub Personal Token
            "xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[0-9a-zA-Z]{24,32}"  # Slack
            "AIza[0-9A-Za-z\\-_]{35}"  # Google API Key
          )
          
          SECRETS_FOUND=0
          SECRET_DETAILS=""
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            MATCHES=$(grep -r -E "$pattern" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.json" 2>/dev/null | wc -l || echo "0")
            if [ "$MATCHES" -gt "0" ]; then
              SECRETS_FOUND=$((SECRETS_FOUND + MATCHES))
              SECRET_DETAILS+="Pattern $pattern: $MATCHES matches\n"
            fi
          done
          
          echo "secrets_found=$SECRETS_FOUND" >> $GITHUB_OUTPUT
          echo "secret_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SECRET_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check security headers
        id: security-headers
        continue-on-error: true
        run: |
          echo "ðŸ›¡ï¸ Checking security headers..."
          
          # Check if site has security headers configured
          # This would typically check the deployed site, but for now we'll check documentation
          HEADERS_CHECKED="true"
          echo "headers_checked=$HEADERS_CHECKED" >> $GITHUB_OUTPUT

      - name: Analyze security issues
        id: analyze
        run: |
          CRITICAL_ISSUES=0
          HIGH_ISSUES=0
          
          if [ "${{ steps.npm-audit.outputs.critical }}" -gt "0" ]; then
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + ${{ steps.npm-audit.outputs.critical }}))
          fi
          
          if [ "${{ steps.npm-audit.outputs.high }}" -gt "0" ]; then
            HIGH_ISSUES=$((HIGH_ISSUES + ${{ steps.npm-audit.outputs.high }}))
          fi
          
          if [ "${{ steps.secret-scan.outputs.secrets_found }}" -gt "0" ]; then
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
          fi
          
          echo "critical_issues=$CRITICAL_ISSUES" >> $GITHUB_OUTPUT
          echo "high_issues=$HIGH_ISSUES" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL_ISSUES" -gt "0" ] || [ "$HIGH_ISSUES" -gt "0" ] || [ "${{ steps.secret-scan.outputs.secrets_found }}" -gt "0" ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-fix npm vulnerabilities
        if: steps.npm-audit.outputs.vulnerabilities > '0' && steps.npm-audit.outputs.critical == '0' && steps.npm-audit.outputs.high == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”§ Attempting to auto-fix moderate/low severity vulnerabilities..."
          
          # Try npm audit fix (only for non-breaking changes)
          npm audit fix --force || npm audit fix || true
          
          if [ -n "$(git status --porcelain package-lock.json)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add package-lock.json
            git commit -m "ðŸ”’ SA: Auto-fix npm vulnerabilities (moderate/low severity)" || exit 0
            git push origin HEAD:${{ github.ref_name }} || echo "Push failed, may need manual review"
          fi

      - name: Create security report
        if: steps.analyze.outputs.has_issues == 'true'
        run: |
          cat > docs/security-report.md <<EOF
          # Security Report - $(date +%Y-%m-%d)
          
          ## Summary
          - **Total Vulnerabilities**: ${{ steps.npm-audit.outputs.vulnerabilities }}
          - **Critical**: ${{ steps.npm-audit.outputs.critical }}
          - **High**: ${{ steps.npm-audit.outputs.high }}
          - **Moderate**: ${{ steps.npm-audit.outputs.moderate }}
          - **Exposed Secrets**: ${{ steps.secret-scan.outputs.secrets_found }}
          
          ## Vulnerabilities
          
          \`\`\`
          $(cat vulnerabilities.txt 2>/dev/null || echo "No vulnerabilities found")
          \`\`\`
          
          ${{ steps.secret-scan.outputs.secrets_found > 0 && format('## Exposed Secrets\n\nâš ï¸ **CRITICAL**: Potential secrets detected in codebase!\n\n```\n{0}\n```\n', steps.secret-scan.outputs.secret_details) || '' }}
          
          ## Recommendations
          
          ${{ steps.npm-audit.outputs.critical > 0 && '1. **URGENT**: Fix critical vulnerabilities immediately' || '' }}
          ${{ steps.npm-audit.outputs.high > 0 && '2. **HIGH PRIORITY**: Address high severity vulnerabilities' || '' }}
          ${{ steps.secret-scan.outputs.secrets_found > 0 && '3. **CRITICAL**: Remove exposed secrets and rotate credentials' || '' }}
          
          ---
          *Generated by SA (Security Agent)*
          EOF

      - name: Create critical security issue
        if: steps.analyze.outputs.critical_issues > '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸ”’ SA: CRITICAL - ${{ steps.analyze.outputs.critical_issues }} critical security issues detected" \
            --body "## Critical Security Alert
          
          **Critical Issues**: ${{ steps.analyze.outputs.critical_issues }}
          **High Issues**: ${{ steps.analyze.outputs.high_issues }}
          
          ## Vulnerabilities
          
          - **Critical**: ${{ steps.npm-audit.outputs.critical }}
          - **High**: ${{ steps.npm-audit.outputs.high }}
          - **Moderate**: ${{ steps.npm-audit.outputs.moderate }}
          - **Total**: ${{ steps.npm-audit.outputs.vulnerabilities }}
          
          ${{ steps.secret-scan.outputs.secrets_found > 0 && format('## âš ï¸ EXPOSED SECRETS DETECTED\n\n**Secrets Found**: {0}\n\n```\n{1}\n```\n\n**ACTION REQUIRED**: Remove exposed secrets immediately and rotate all credentials!', steps.secret-scan.outputs.secrets_found, steps.secret-scan.outputs.secret_details) || '' }}
          
          ## Vulnerability Details
          
          \`\`\`
          $(cat vulnerabilities.txt 2>/dev/null || echo "No details available")
          \`\`\`
          
          ## Immediate Actions Required
          
          1. Review all critical vulnerabilities
          2. Update dependencies with security patches
          3. ${{ steps.secret-scan.outputs.secrets_found > 0 && 'Remove exposed secrets and rotate credentials' || 'Review high severity issues' }}
          4. Run \`npm audit fix\` for auto-fixable issues
          
          ---
          *Generated by SA (Security Agent)*" \
            --label "security,critical,automated" || echo "Issue may already exist"

      - name: Create security PR for fixes
        if: steps.npm-audit.outputs.vulnerabilities > '0' && steps.npm-audit.outputs.critical == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH_NAME="sa/security-fixes-$(date +%Y%m%d)"
            git checkout -b "$BRANCH_NAME"
            git add .
            git commit -m "ðŸ”’ SA: Security fixes - ${{ steps.npm-audit.outputs.vulnerabilities }} vulnerabilities addressed" || exit 0
            
            gh pr create \
              --title "ðŸ”’ SA: Security fixes (${{ steps.npm-audit.outputs.vulnerabilities }} vulnerabilities)" \
              --body "## Security Fixes
          
          **Vulnerabilities Addressed**: ${{ steps.npm-audit.outputs.vulnerabilities }}
          - High: ${{ steps.npm-audit.outputs.high }}
          - Moderate: ${{ steps.npm-audit.outputs.moderate }}
          
          ## Changes
          
          This PR includes security fixes automatically generated by SA (Security Agent).
          
          ## Review Required
          
          Please review the changes and ensure they don't break functionality.
          
          ---
          *Generated by SA (Security Agent)*" \
              --label "security,automated" || echo "PR creation skipped"
          fi

      - name: Success summary
        if: steps.analyze.outputs.has_issues == 'false'
        run: |
          echo "âœ… Security scan passed!"
          echo "No vulnerabilities or security issues detected."

