name: Unified Autonomous Agent

on:
  # CI Fix triggers
  workflow_run:
    workflows: ["CI", "Tests", "Build"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      capability:
        description: 'Capability to run (ci-fix, link-health, security, all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - ci-fix
          - link-health
          - security
  # Link Health triggers
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  push:
    paths:
      - '**.html'
      - '**.md'
      - 'index.html'
      - 'package.json'
      - 'package-lock.json'
      - '**/*.js'
      - '**/*.py'

jobs:
  unified-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (apt update && apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          apt update
          apt install gh -y

      - name: Make scripts executable
        run: |
          chmod +x agents/router.sh
          chmod +x agents/capabilities/*/*.sh
          chmod +x agents/shared/*.sh

      - name: Determine capability to run
        id: determine-capability
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" == "failure" ]; then
              echo "capability=ci-fix" >> $GITHUB_OUTPUT
              echo "workflow_event=workflow_run" >> $GITHUB_OUTPUT
            else
              echo "capability=skip" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "capability=${{ github.event.inputs.capability }}" >> $GITHUB_OUTPUT
            echo "workflow_event=workflow_dispatch" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            echo "capability=all" >> $GITHUB_OUTPUT
            echo "workflow_event=schedule" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            # Check which files changed
            if echo "${{ github.event.head_commit.modified }}" | grep -qE "(\.html|\.md|index\.html)"; then
              echo "capability=link-health" >> $GITHUB_OUTPUT
            elif echo "${{ github.event.head_commit.modified }}" | grep -qE "(package\.json|package-lock\.json|\.js|\.py)"; then
              echo "capability=security" >> $GITHUB_OUTPUT
            else
              echo "capability=all" >> $GITHUB_OUTPUT
            fi
            echo "workflow_event=push" >> $GITHUB_OUTPUT
          else
            echo "capability=all" >> $GITHUB_OUTPUT
            echo "workflow_event=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Get failed workflow logs (for CI-Fix)
        if: steps.determine-capability.outputs.capability == 'ci-fix'
        id: get-logs
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            RUN_ID="${{ github.event.workflow_run.id }}"
            WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
            
            echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
            echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
            
            echo "Downloading logs for workflow: $WORKFLOW_NAME"
            gh run view $RUN_ID --log > workflow_logs.txt 2>&1 || true
            
            if [ ! -s workflow_logs.txt ]; then
              echo "Warning: workflow_logs.txt is empty or doesn't exist"
            else
              echo "Logs downloaded successfully ($(wc -l < workflow_logs.txt) lines)"
            fi
          else
            echo "Manual trigger - searching for latest failed CI run..."
            gh run list --workflow=CI --limit 1 --json databaseId,conclusion --jq '.[] | select(.conclusion=="failure") | .databaseId' | head -1 > run_id.txt || echo "" > run_id.txt
            RUN_ID=$(cat run_id.txt)
            if [ ! -z "$RUN_ID" ]; then
              echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
              echo "Downloading logs for run ID: $RUN_ID"
              gh run view $RUN_ID --log > workflow_logs.txt 2>&1 || true
            else
              echo "No failed CI runs found"
            fi
          fi

      - name: Initialize UAA Status File
        if: steps.determine-capability.outputs.capability != 'skip'
        run: |
          mkdir -p docs
          # Initialize status file if it doesn't exist
          if [ ! -f "docs/uaa-status.json" ]; then
            cat > docs/uaa-status.json << 'EOF'
          {
            "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "workflow_status": "unknown",
            "capabilities": {
              "ci-fix": {
                "status": "unknown",
                "last_run": "N/A",
                "last_success": "N/A",
                "last_failure": "N/A",
                "total_runs": 0,
                "success_count": 0,
                "failure_count": 0
              },
              "link-health": {
                "status": "unknown",
                "last_run": "N/A",
                "last_success": "N/A",
                "last_failure": "N/A",
                "total_runs": 0,
                "success_count": 0,
                "failure_count": 0
              },
              "security": {
                "status": "unknown",
                "last_run": "N/A",
                "last_success": "N/A",
                "last_failure": "N/A",
                "total_runs": 0,
                "success_count": 0,
                "failure_count": 0
              }
            },
            "recent_activity": []
          }
          EOF
          fi
          # Update workflow status to running
          if command -v jq >/dev/null 2>&1; then
            jq '.workflow_status = "running" | .last_updated = "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"' docs/uaa-status.json > docs/uaa-status.json.tmp && mv docs/uaa-status.json.tmp docs/uaa-status.json || true
          fi

      - name: Run Unified Agent (UAA)
        if: steps.determine-capability.outputs.capability != 'skip'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          bash agents/router.sh "${{ steps.determine-capability.outputs.capability }}" "${{ steps.determine-capability.outputs.workflow_event }}" || {
            EXIT_CODE=$?
            # Update status even on failure
            bash agents/shared/update_status.sh "ci-fix" "failure" "UAA router failed with exit code $EXIT_CODE" || true
            exit $EXIT_CODE
          }

      - name: Update UAA Status and Dashboard
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Install jq if needed
          sudo apt-get update && sudo apt-get install -y jq || true
          
          # Ensure status file exists
          mkdir -p docs
          if [ ! -f "docs/uaa-status.json" ]; then
            cat > docs/uaa-status.json << 'EOF'
          {
            "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "workflow_status": "${{ job.status }}",
            "capabilities": {
              "ci-fix": {"status": "unknown", "last_run": "N/A", "last_success": "N/A", "last_failure": "N/A", "total_runs": 0, "success_count": 0, "failure_count": 0},
              "link-health": {"status": "unknown", "last_run": "N/A", "last_success": "N/A", "last_failure": "N/A", "total_runs": 0, "success_count": 0, "failure_count": 0},
              "security": {"status": "unknown", "last_run": "N/A", "last_success": "N/A", "last_failure": "N/A", "total_runs": 0, "success_count": 0, "failure_count": 0}
            },
            "recent_activity": []
          }
          EOF
          fi
          
          # Update workflow status
          if command -v jq >/dev/null 2>&1; then
            jq ".workflow_status = \"${{ job.status }}\" | .last_updated = \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"" docs/uaa-status.json > docs/uaa-status.json.tmp && mv docs/uaa-status.json.tmp docs/uaa-status.json || true
          fi
          
          # Make status scripts executable
          chmod +x agents/shared/update_status.sh
          chmod +x agents/shared/generate_status_dashboard.sh
          
          # Generate status dashboard
          bash agents/shared/generate_status_dashboard.sh > /tmp/uaa-dashboard.md || {
            # Fallback if dashboard generation fails
            cat > /tmp/uaa-dashboard.md << 'EOF'
          ## UAA Status Dashboard

          **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          | Component | Status | Last Run | Details |
          |-----------|--------|----------|---------|
          | **UAA Workflow** | [${{ job.status }}] ${{ job.status }} | $(date -u +"%Y-%m-%d %H:%M:%S UTC") | [View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | **CI-Fix Capability** | [UNKNOWN] Unknown | N/A | [View Status](./docs/uaa-status.json) |
          | **Link-Health Capability** | [UNKNOWN] Unknown | N/A | [View Status](./docs/uaa-status.json) |
          | **Security Capability** | [UNKNOWN] Unknown | N/A | [View Status](./docs/uaa-status.json) |

          ### Quick Links
          - [UAA Success Indicators Guide](./docs/UAA_SUCCESS_INDICATORS.md)
          - [UAA Architecture](./docs/UNIFIED_AGENT_ARCHITECTURE.html)
          - [Agent README](./agents/README.md)
          - [View All Workflow Runs](https://github.com/${{ github.repository }}/actions/workflows/unified-autonomous-agent.yml)

          ---
          *Dashboard auto-updated by UAA after each run*
          EOF
          }
          
          # Update README with dashboard
          python3 << 'PYTHON_SCRIPT'
          import re
          import sys
          
          with open('README.md', 'r', encoding='utf-8') as f:
              readme = f.read()
          
          # Read dashboard content
          with open('/tmp/uaa-dashboard.md', 'r', encoding='utf-8') as f:
              dashboard = f.read()
          
          # Find and replace dashboard section
          pattern = r'(## UAA Status Dashboard.*?---\s*\*Dashboard auto-updated.*?\*)'
          replacement = dashboard
          
          if re.search(pattern, readme, re.DOTALL):
              readme = re.sub(pattern, replacement, readme, flags=re.DOTALL)
          else:
              # Insert after "## Autonomous Agents Ecosystem" section
              insert_pos = readme.find('## Autonomous Agents Ecosystem')
              if insert_pos != -1:
                  # Find end of that section
                  next_section = readme.find('\n## ', insert_pos + 1)
                  if next_section == -1:
                      next_section = len(readme)
                  readme = readme[:next_section] + '\n\n' + dashboard + '\n\n' + readme[next_section:]
          
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(readme)
          
          print("README dashboard updated successfully")
          PYTHON_SCRIPT
          
          # Commit and push dashboard update
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md docs/uaa-status.json docs/uaa-diagnostics.json 2>/dev/null || true
          if [ -n "$(git status --porcelain README.md docs/uaa-status.json docs/uaa-diagnostics.json 2>/dev/null)" ]; then
            git commit -m "UAA: Update status dashboard [skip ci]" || true
            git push origin HEAD:${{ github.ref_name }} || true
          fi

      - name: UAA execution summary
        if: always()
        run: |
          echo "========================================="
          echo "UAA (Unified Autonomous Agent) - Execution Summary"
          echo "========================================="
          echo "Capability: ${{ steps.determine-capability.outputs.capability }}"
          echo "Workflow Event: ${{ steps.determine-capability.outputs.workflow_event }}"
          echo "Status: ${{ job.status }}"
          if [ "${{ job.status }}" == "failure" ]; then
            echo ""
            echo "[WARNING] UAA encountered an error. Diagnostic information:"
            if [ -f "docs/uaa-diagnostics.json" ]; then
              echo "View diagnostics: docs/uaa-diagnostics.json"
              cat docs/uaa-diagnostics.json | jq '.' 2>/dev/null || cat docs/uaa-diagnostics.json
            fi
          fi
          echo "========================================="

